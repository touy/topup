<script>

	var clientjs = new ClientJS();
	//var generateclient={{generateclient}};
	var client={{{client}}};
	if(client==""||client==null||client=="undefined")
		window.location="/error";
	/*
	var client={
	    username:"",
	    logintoken:"",
	    logintime:null,
	    logintimeout:null,
	    clientuid:null,
	    registeruid:null,
	    confirmregisteruid:null,
	    browserinfo:"",
	    ip:"",
	    other:"",
	    lastaccess:null,
	    isexist:false,
	    clientjs:"",
	    fingerprint:"",
	    data:""
	    };
	*/
	// if exist update the current one
	var x_client="";
	function isJson(str) {
	    try {
	        JSON.parse(str);
	    } catch (e) {
	        return false;
	    }
	    return true;
	}
	function sendPost(js) {
	       $.post(
	         js,
	         function(js) {
	           console.log(js);
	         }
	       );
	     }

	//try to get data from client local database
	if (typeof(Storage) !== "undefined") {
		
		y_client=client;
		console.log("x_client:"+x_client);
	    x_client=localStorage.getItem("client");
	    if(!isJson(x_client))
	    	x_client=localStorage.setItem("client",client);
		//if not exist create a new one 
		console.log("x_client:"+x_client);
		if(x_client==null || x_client=="undefined" || x_client=="")
		{		
			localStorage.setItem("client",client);
		}
		else 
			client=x_client;

		// var client={
	 //    username:"",
	 //    logintoken:"",
	 //    logintime:null,
	 //    logintimeout:null,
	 //    clientuid:null,
	 //    registeruid:null,
	 //    confirmregisteruid:null,
	 //    browserinfo:"",
	 //    ip:"",
	 //    other:"",
	 //    lastaccess:null,
	 //    isexist:false,
	 //    clientjs:"",
	 //    fingerprint:"",
	 //    data:""
	 //    };


		

		// when login exist
		if(client.logintoken!="")
		{
			var d=new Date();
			client.logintime=d;		
			client.browserinfo=clientjs.getUserAgent(); 		
			client.clientjs=clientjs;
			client.isexist=true;
			client.lastaccess=new Date();

			d.setDate(d.getDate()+30);//timeout would be current time + 30days
			client.logintimeout=d;
			client.ip=y_client.ip;
			client.fingerprint=clientjs.fingerprint;
			//if(client.logintimeout<=d)
				//window.location="/home/"+JSON.stringify(client); //redirect to login page login timeout
		}
		else
		{
			//need to login
			client.clientjs=clientjs;
			client.isexist=false;
			client.lastaccess=new Date();
			window.location="/home/"+JSON.stringify(client);
		}
	} 
	else {
	    alert("Sorry, your browser does not support Web Storage...");
	}

	//redirect to the home page to login or pre-register
	if(client!=""&&client!=null)
		window.location="/home/"+JSON.stringify(client);
</script>